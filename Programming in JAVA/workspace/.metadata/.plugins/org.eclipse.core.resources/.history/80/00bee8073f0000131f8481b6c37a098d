##########################################################################
# Push: Get last status
##########################################################################
#Get last status in SQLite
import sqlite3
conn = sqlite3.connect('iFederal.db')
c = conn.cursor()

for row in c.execute('select * from tblStatus ORDER BY id DESC LIMIT 1'):
    ID =  row[0]
    Status = row[1]
    Date = row[2]

for row in c.execute('select Status from tblStatus where id = '+str(ID)):
    prevStatus = row[0]

if (Status==prevStatus):
    IsChanged = 'Still Waiting'
else:
    IsChanged = 'Status Changed'

#print ID,Status,Date,IsChanged

c.close()
conn.close()

##########################################################################
# Push: Send email
##########################################################################
import smtplib
from email.mime.text import MIMEText
from email.header import Header
FROM = 'CIC.GC.CA'
TO = ['15184330604@139.com','13402850347@139.com','camelchen@qq.com']
#CC = 'camelchen@qq.com'

smtpserver = 'smtp.gmail.com'
username = 'quebecjms@gmail.com'
password = 'jms1qaz!QAZ'

msg = MIMEText(str(Status),'plain','UTF-8')
msg['From'] = 'CIC.GC.CA'
msg['Subject'] = Header(IsChanged, 'UTF-8')

smtp = smtplib.SMTP()
smtp.connect(smtpserver)
smtp.ehlo()
smtp.starttls()
smtp.ehlo()

smtp.login(username, password)
smtp.sendmail(FROM,TO,msg.as_string())
smtp.quit()